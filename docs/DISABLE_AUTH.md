# 禁用用户认证功能说明

## 概述

WeKnora 支持禁用用户认证功能，适用于内网部署或不需要多用户管理的场景。启用此功能后，用户可以直接访问系统，无需注册和登录。

## 使用场景

- **内网部署**：在企业内网环境中部署，所有员工共享同一个知识库系统
- **个人使用**：个人本地部署，无需用户管理功能
- **演示环境**：快速搭建演示环境，方便展示系统功能

## 配置方法

### 方式一：通过环境变量配置（推荐）

1. 编辑 `.env` 文件，添加或修改以下配置：

```bash
# 禁用用户认证（设为 true 后无需登录即可使用）
DISABLE_AUTH=true
```

2. 重启服务：

```bash
./scripts/start_all.sh --stop
./scripts/start_all.sh
```

### 方式二：通过配置文件配置

1. 编辑 `config/config.yaml` 文件，修改 server 配置：

```yaml
server:
  port: 8080
  host: "0.0.0.0"
  disable_auth: true
```

2. 重启服务

## 功能说明

### 启用禁用认证后的行为

1. **自动创建默认租户**
   - 系统会自动创建一个名为"默认租户"的租户（ID为1）
   - 所有用户共享这个默认租户的数据

2. **跳过认证检查**
   - 所有 API 请求无需提供 Authorization 或 X-API-Key 头
   - 前端页面不会显示登录/注册界面
   - 用户可以直接访问首页和所有功能

3. **数据隔离**
   - 所有数据都存储在默认租户下
   - 如果后续需要启用认证，已有数据会保留在默认租户中

### 前端访问

启用禁用认证后，直接访问以下地址即可使用：

```
http://localhost
```

系统会自动跳过登录页面，直接进入主界面。

### 隐藏 Ollama 相关设置（可选）

如果你不使用本地 Ollama 服务，可以在前端隐藏相关设置选项：

1. 编辑 `.env` 文件：
```bash
HIDE_OLLAMA=true
```

2. 重启服务

这样前端界面将不再显示 Ollama 相关的配置选项，界面更加简洁。

## 安全注意事项

⚠️ **重要提示**：

1. **仅适用于内网环境**
   - 禁用认证后，任何能访问系统的人都可以查看和修改所有数据
   - 不要在公网环境中启用此功能

2. **数据安全**
   - 建议配合防火墙规则，限制访问来源
   - 定期备份数据

3. **生产环境建议**
   - 生产环境建议保持认证功能开启
   - 如需禁用认证，请确保网络环境安全可控

## 恢复认证功能

如果需要重新启用认证功能：

1. 修改 `.env` 文件：

```bash
DISABLE_AUTH=false
```

2. 重启服务

3. 访问系统时会要求登录

4. 可以注册新用户或使用已有账户登录

## 常见问题

### Q: 禁用认证后，之前创建的用户账户还能用吗？

A: 可以。禁用认证只是跳过了认证检查，用户数据仍然保留。重新启用认证后，可以继续使用原有账户登录。

### Q: 禁用认证后，API Key 还有效吗？

A: 禁用认证后，API Key 不再需要。但如果重新启用认证，原有的 API Key 仍然有效。

### Q: 可以在禁用认证模式下创建多个租户吗？

A: 技术上可以通过 API 创建，但不推荐。禁用认证模式设计为单租户使用场景。

### Q: 禁用认证会影响性能吗？

A: 不会。禁用认证只是跳过了认证检查步骤，对系统性能没有负面影响。

## 技术实现

禁用认证功能的技术实现：

1. **中间件层面**：在认证中间件中检查 `disable_auth` 配置，如果为 true，则跳过认证检查
2. **租户管理**：自动创建或获取 ID 为 1 的默认租户
3. **上下文注入**：将默认租户信息注入到请求上下文中，确保后续业务逻辑正常运行

相关代码文件：
- `internal/middleware/auth.go` - 认证中间件
- `internal/config/config.go` - 配置定义
- `internal/application/service/tenant.go` - 租户服务
- `config/config.yaml` - 配置文件

## 更新日志

- 2025-01-18: 添加禁用认证功能
